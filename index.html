<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dutroux Sell🔥</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- === НОВЫЙ СТИЛЬ: неоново-тёмная тема, сохранены все id/class === -->
  <style>
    :root{
      --bg-1: #07060a;
      --bg-2: #0f1724;
      --card: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.03);
      --neon-yellow: #ffd800;
      --neon-red: #ff385c;
      --neon-cyan: #00d4ff;
      --muted: rgba(255,255,255,0.6);
      --accent-glow: 0 8px 30px rgba(0, 212, 255, 0.08), 0 2px 8px rgba(186,255,0,0.06);
      --radius: 14px;
    }

    /* Reset & base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100%;
      font-family:"Poppins", "Montserrat", system-ui, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,212,255,0.04), transparent 8%),
        radial-gradient(1000px 500px at 90% 90%, rgba(186,255,0,0.02), transparent 8%),
        linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#eaf6ff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:78px; /* space for bottom nav */
      overflow-x:hidden;
    }

    /* Header */
    .header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:16px;
      position:relative;
      z-index:30;
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .header img{height:44px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    .header h1{
      font-size:18px;
      margin:0;
      line-height:1;
      letter-spacing:0.2px;
      color:var(--neon-cyan);
      text-shadow: 0 2px 18px rgba(0,212,255,0.08);
      font-weight:700;
    }

    .divider-horizontal{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
      margin: 6px 0 8px 0;
    }

    /* Marquee / categories */
    .category-marquee{
      overflow:hidden;
      padding:8px 0;
      border-top:1px solid rgba(255,255,255,0.02);
      border-bottom:1px solid rgba(255,255,255,0.02);
      background: linear-gradient(90deg, rgba(0,0,0,0.15), transparent);
      position:relative;
      z-index:20;
    }
    .category-track{
      display:flex;
      gap:12px;
      animation: marquee 14s linear infinite;
      padding-left:6px;
    }
    @keyframes marquee{
      0%{transform:translateX(0)}
      100%{transform:translateX(-50%)}
    }
    .category{
      border:1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      color: #fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .category:hover{
      transform: translateY(-3px);
      border-color: rgba(186,255,0,0.9);
      box-shadow: 0 10px 30px rgba(186,255,0,0.06);
    }

    /* Catalog wrapper */
    .tab-content{padding:12px 14px 120px 14px}

    .catalog-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .catalog-header .bar{
      width:4px;height:28px;border-radius:4px;
      background: linear-gradient(180deg,var(--neon-cyan),var(--neon-yellow));
      box-shadow: 0 6px 20px rgba(0,212,255,0.06);
    }
    .catalog-header .title{
      font-weight:700;
      font-size:18px;
      color:#fff;
    }

    /* Products grid (preserve product-card class) */
    #catalog .product-card{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      margin-bottom:12px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border: 1px solid rgba(255,255,255,0.03);
      transition: transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .22s ease, border-color .22s ease;
      position:relative;
      overflow:hidden;
    }
    /* Neon outline using pseudo-element */
    #catalog .product-card::after{
      content:'';
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius:12px;
      box-shadow: 0 0 40px rgba(0,212,255,0.03), inset 0 0 18px rgba(186,255,0,0.02);
      transition: opacity .22s ease;
      opacity:0;
    }
    #catalog .product-card img{
      width:84px;
      height:84px;
      object-fit:cover;
      border-radius:10px;
      flex-shrink:0;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
    }
    #catalog .product-card:hover{ transform: translateY(-6px); border-color: rgba(186,255,0,0.7);}
    #catalog .product-card:hover::after{ opacity:1; }

    .product-info{
      flex:1;
      min-width:0;
    }
    .product-title{
      font-weight:700;
      font-size:16px;
      color:#fff;
      margin-bottom:6px;
      text-overflow:ellipsis;
      overflow:hidden;
      white-space:nowrap;
    }
    .product-description{
      color:var(--muted);
      font-size:13px;
      margin-bottom:8px;
      display:block;
    }
    .product-price{
      color:var(--neon-yellow);
      font-weight:700;
      font-size:14px;
      display:inline-block;
    }
    .product-info .details-btn, .product-info .add-btn{
      margin-top:10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:10px;
      border:none;
      font-weight:700;
      cursor:pointer;
      transition: transform .14s ease, box-shadow .14s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }
    .product-info .details-btn{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      color:#cfefff;
      border:1px solid rgba(255,255,255,0.04);
      margin-right:8px;
    }
    .product-info .details-btn:hover{ transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.6); }

    .product-info .add-btn{
      background: linear-gradient(90deg, var(--neon-yellow), var(--neon-red));
      color:#000;
      border: none;
      padding:8px 12px;
    }
    .product-info .add-btn:hover{
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 10px 30px rgba(255,56,92,0.12), 0 6px 18px rgba(186,255,0,0.06);
    }

    /* Modal tweaks (preserve .modal .modal-content) */
    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.7));
      z-index:1200;
      padding:20px;
    }
    .modal.hidden{ display:none; }
    .modal-content{
      width:100%;
      max-width:440px;
      background: linear-gradient(180deg, rgba(9,14,24,0.9), rgba(6,8,12,0.95));
      border-radius:16px;
      padding:18px;
      color:#eaf6ff;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      border:1px solid rgba(255,255,255,0.03);
      position:relative;
    }
    .modal-content h2, .modal-content h3{
      margin-top:0;
      color:var(--neon-yellow);
      text-shadow: 0 6px 28px rgba(186,255,0,0.03);
    }
    .modal-content button{
      background: linear-gradient(90deg, var(--neon-yellow), var(--neon-red));
      color:#000;
      border:none;
      padding:10px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 12px 30px rgba(255,56,92,0.08);
    }
    .modal-content input, .modal-content textarea{
      background:#0f1724;
      border:1px solid rgba(255,255,255,0.04);
      color:#eaf6ff;
      padding:10px;
      border-radius:10px;
      width:100%;
      outline:none;
    }
    .close-btn{
      position:absolute;
      top:12px;
      right:14px;
      font-size:22px;
      color:#fff;
      opacity:0.95;
      cursor:pointer;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      width:36px;height:36px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.03);
    }
    .review-item{
      margin-top:10px;border-top:1px dashed rgba(255,255,255,0.04);
      padding-top:8px;font-size:14px;color:var(--muted);
    }
    .review-author{ color:var(--neon-yellow); font-weight:700; }

    /* Profile & cards */
    .styled-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.03);
      padding:12px;border-radius:12px;margin-bottom:12px;
    }

    /* Bottom navigation (preserve .bottom-nav) */
    .bottom-nav{
      position:fixed;
      left:12px;right:12px;bottom:12px;
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-around;
      gap:8px;
      background: linear-gradient(180deg, rgba(8,10,20,0.9), rgba(6,8,12,0.85));
      border-radius:18px;
      padding:6px 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7);
      border:1px solid rgba(255,255,255,0.03);
      z-index:40;
    }
    .bottom-nav button{
      background:transparent;border:0;color:var(--neon-yellow);font-weight:700;
      display:flex;flex-direction:column;align-items:center;gap:4px;font-size:12px;cursor:pointer;
    }
    .bottom-nav button img{width:20px;height:20px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6));}
    .bottom-nav button.active, .bottom-nav button:hover{ color:var(--neon-red); transform:translateY(-2px); }

    /* Cart area */
    .cart-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 4px 12px 4px;}
    .cart-body{ padding:8px 4px; color:var(--muted); min-height:80px; }

    /* small utilities */
    .back-btn{ background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer }
    .checkout-btn{ display:inline-block;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--neon-yellow),var(--neon-red));border:none;color:#000;font-weight:800;cursor:pointer }

    /* Responsive tweaks */
    @media (min-width:720px){
      .modal-content{ max-width:520px; }
      #catalog .product-card{ align-items:center; gap:14px; padding:14px }
      #catalog .product-card img{ width:110px;height:110px;border-radius:12px }
    }
    @media (max-width:420px){
      .header h1{ font-size:16px }
      .category{ padding:7px 10px; font-size:12px }
      .bottom-nav{ height:72px; left:8px; right:8px; bottom:8px; border-radius:14px;}
    }

    /* subtle entrance */
    .tab-pane{ opacity:1; transform:none; transition: none; }
    /* toast (uses existing JS element #toast) */
    #toast{ border-radius:12px; padding:12px 18px; font-weight:600; letter-spacing:0.2px; box-shadow: 0 12px 30px rgba(0,0,0,0.6); }
    #toast.show{ opacity:1 !important; transform: translateY(0) !important; }

  </style>
  <!-- === Конец стиля === -->
</head>
<body>

  <div class="header" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px;">
    <img src="logo.png" alt="Logo" style="height: 40px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
    <h1 style="font-size: 24px; color: #fff; font-family: 'Arial', sans-serif;">Dutroux Sell 🔥</h1>
  </div>
  <div class="divider-horizontal"></div>

  <!-- Бегущие категории -->
  <div class="category-marquee">
    <div class="category-track">
      <button class="category">Приватка 💸</button>
      <button class="category">Превью 🚀</button>
      <button class="category">Оформление 🔥</button>
      <button class="category">Приватка 💸</button>
      <button class="category">Превью 🚀</button>
      <button class="category">Оформление 🔥</button>
    </div>
  </div>

  <!-- Основной контент -->

  <div class="tab-content">
    <!-- КАТАЛОГ -->
<div id="catalog" class="tab-pane active">
  <div class="catalog-header">
    <div class="bar"></div>
    <div class="title">Товары</div>
  </div>

  <!-- ТОВАРЫ -->
  <div class="product-card" data-name="Превью" data-price="200" data-image="preview.png" data-desc="Красочное превью для Вашего канала">
    <img src="preview.png" alt="Preview">
    <div class="product-info">
      <div class="product-title">Превью</div>
      <div class="product-description">Красочное превью для Вашего канала</div>
      <div class="product-price">200 ₽</div>
      <button class="details-btn">Подробнее</button>
      <button class="add-btn">Добавить в корзину</button>
    </div>
  </div>

  <div class="product-card" data-name="Приватка" data-price="300" data-image="privatka.png" data-desc="Доступ к приватному контенту для подписчиков">
    <img src="privatka.png" alt="Приватка">
    <div class="product-info">
      <div class="product-title">Приватка</div>
      <div class="product-description">Доступ к приватному контенту для подписчиков</div>
      <div class="product-price">300 ₽</div>
      <button class="details-btn">Подробнее</button>
      <button class="add-btn">Добавить в корзину</button>
    </div>
  </div>

  <!-- 🆕 Новый товар: Оформление для YT канала -->
  <div class="product-card" data-name="Оформление для YT канала" data-price="500" data-image="yt-design.png" data-desc="Профессиональное оформление для вашего YouTube-канала (баннер, аватар, стиль)">
    <img src="yt-design.png" alt="Оформление для YT канала">
    <div class="product-info">
      <div class="product-title">Оформление для YT канала</div>
      <div class="product-description">Профессиональное оформление для вашего YouTube-канала (баннер, аватар, стиль)</div>
      <div class="product-price">500 ₽</div>
      <button class="details-btn">Подробнее</button>
      <button class="add-btn">Добавить в корзину</button>
    </div>
  </div>

  <!-- 🆕 Новый товар: 2 Превью по цене 1 -->
  <div class="product-card" data-name="3 Превью по цене 2" data-price="400" data-image="2for1.png" data-desc="Получите три уникальных превью по цене двух — выгодное предложение!">
    <img src="2for1.png" alt="3 Превью по цене 2">
    <div class="product-info">
      <div class="product-title">3 Превью по цене 2</div>
      <div class="product-description">Получите три уникальных превью по цене двух — выгодное предложение!</div>
      <div class="product-price">400 ₽</div>
      <button class="details-btn">Подробнее</button>
      <button class="add-btn">Добавить в корзину</button>
    </div>
  </div>

</div> <!-- ✅ Закрытие #catalog -->

    <!-- МОДАЛКА "ПОДРОБНЕЕ" -->
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <span class="close-btn" id="detailsCloseBtn">&times;</span>
        <img id="modal-img" src="" alt="" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;">
        <h2 id="modal-title"></h2>
        <p id="modal-desc"></p>
        <div class="modal-price" id="modal-price"></div>
        <button id="modal-add">Добавить в корзину</button>

        <div id="reviews-container">
          <h3>Отзывы:</h3>
          <div id="modal-reviews"></div>
          <textarea id="reviewInput" rows="3" placeholder="Напишите ваш отзыв..."></textarea>
          <button id="submitReview">Оставить отзыв</button>
        </div>
      </div>
    </div>

    <!-- КОРЗИНА -->
    <div id="cart" class="tab-pane">
      <div class="cart-header">
        <button class="back-btn" onclick="goToTab('catalog')">← Назад</button>
        <div class="title">Корзина</div>
        <div class="total" id="total">0,00 ₽</div>
      </div>
      <div class="cart-body" id="cart-body">Здесь будут ваши товары.</div>
      <button class="checkout-btn" id="checkout-btn" style="display: none;">Перейти к оформлению</button>
    </div>

    <!-- ПРОФИЛЬ -->
<div id="profile" class="tab-pane">
  <div class="profile-card styled-card">
    <div class="profile-header" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
      <div style="flex-shrink: 0;">
        <div style="position: relative; width: 70px; height: 70px; cursor: pointer;" onclick="document.getElementById('avatarModal').classList.remove('hidden')">
          <img id="user-avatar" src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="Avatar"
               style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 10px rgba(0,0,0,0.4);" />
          <img src="https://cdn-icons-png.flaticon.com/512/84/84380.png" alt="Edit" title="Изменить аватар"
               style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; padding: 2px;" />
        </div>
      </div>
      <div style="text-align: right;">
        <div id="profile-username" style="font-size: 18px; font-weight: bold;">Имя пользователя</div>
        <div id="profile-tg" style="font-size: 14px; color: #ccc;">@username</div>
        <div id="profile-id" style="font-size: 14px; color: #888;">ID: 123456</div>
      </div>
    </div>
  </div>

  <!-- БАЛАНС -->
  <div class="balance-card styled-card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>Ваш баланс:</div>
      <div id="balance-amount" style="font-weight: bold; font-size: 18px;">0 ₽</div>
    </div>
    <button id="topup-btn" style="margin-top: 10px;">Пополнить баланс</button>
  </div>

  <hr style="margin: 18px 0; border-color: #333;">

  <!-- ПРОМОКОД -->
  <div class="promocode-card styled-card">
    <div>Промокод:</div>
    <input type="text" id="promo-input" placeholder="Введите промокод" style="width: 95%; box-sizing: border-box; margin-top: 8px;">
    <button id="promo-btn">Активировать</button>
    <div id="promo-message" class="promo-error"></div>
  </div>

  <hr style="margin: 18px 0; border-color: #333;">

  <!-- ПРОШЛЫЕ ЗАКАЗЫ -->
  <div class="orders-card styled-card">
    <div style="font-weight: bold; margin-bottom: 10px;">Прошлые заказы:</div>
    <div id="order-history">Загрузить заказы...</div>
  </div>
</div>

  <div id="avatarModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('avatarModal').classList.add('hidden')">&times;</span>
      <h3>Выберите аватар</h3>
      <p>Можно загрузить свой (1000x1000 PNG/JPG):</p>
      <input type="file" id="avatarUpload" accept="image/png, image/jpeg" />
      <hr style="margin: 15px 0;">
      <p>Или выбрать из готовых:</p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <img src="blue.png" class="preset-avatar" alt="blue" width="60">
        <img src="green.png" class="preset-avatar" alt="green" width="60">
        <img src="purple.png" class="preset-avatar" alt="purple" width="60">
        <img src="red.png" class="preset-avatar" alt="red" width="60">
      </div>
    </div>
  </div>

  <!-- НАВИГАЦИЯ -->
  <div class="bottom-nav">
    <button class="active" data-tab="catalog"><img src="home.svg" alt=""><span>Каталог</span></button>
    <button data-tab="cart"><img src="cart.svg" alt=""><span>Корзина</span></button>
    <button data-tab="profile"><img src="profile.svg" alt=""><span>Профиль</span></button>
  </div>

  <!-- МОДАЛКА ВВОДА USERNAME -->
  <div id="usernameModal" class="modal hidden">
    <div class="modal-content">
      <span id="usernameCloseBtn" class="close-btn">&times;</span>
      <h3>Укажите ваш Telegram username</h3>
      <p>Это нужно, чтобы мы могли найти ваш платёж и выслать товар.</p>
      <input type="text" id="tgUsernameInput" placeholder="@username" style="width: 100%; margin-top: 10px;">
      <div style="margin-top: 15px;">
        <button id="submitUsername">ОК</button>
      </div>
    </div>
  </div>

  <div id="orderModal" class="modal hidden">
    <div class="modal-content" style="background: #142537;">
      <span class="close-btn" id="orderCloseBtn">&times;</span>
      <h2 style="color: #ffffff; font-size: 22px; margin-bottom: 15px; text-align: center;">
        К ОПЛАТЕ: <span id="order-total">... ₽</span>
      </h2>

      <div id="order-items-container" style="margin: 15px 0;">
        <!-- Сюда динамически вставим содержимое корзины -->
      </div>

      <div style="width: 100%; height: auto;">
        <hr style="border: none; border-top: 2px dashed #ffffff; margin: 20px 0;">
      </div>

      <div class="promocode-card styled-card" style="margin-top: 20px;">
        <div style="color: #fff;">Промокод:</div>
        <input type="text" id="checkout-promo-input" placeholder="Введите промокод"
               style="width: 95%; box-sizing: border-box; margin-top: 8px; background-color: #0f1e33; color: white; border: 1px solid #33445a; border-radius: 6px; padding: 8px;">
        <button id="checkout-promo-btn"
                style="margin-top: 10px; background-color: #0077ff; color: #fff; border: none; border-radius: 6px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
          Активировать
        </button>
        <div id="checkout-promo-message" class="promo-error"></div>
      </div>

      <button id="paidButton" style="margin-top: 25px; background: #007bff; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer;">
        Оплатить
      </button>
    </div>
  </div>

<!-- ====== JS (твоя логика оставлена как есть) ====== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  // Создание и стилизация toast
  const toast = document.createElement('div');
  toast.id = 'toast';
  Object.assign(toast.style, {
    position: 'fixed',
    bottom: '20px',
    left: '50%',
    transform: 'translateX(-50%)',
    background: 'rgba(0, 0, 0, 0.85)',
    color: '#fff',
    padding: '14px 24px',
    borderRadius: '12px',
    opacity: '0',
    pointerEvents: 'none',
    transition: 'opacity 0.4s ease',
    zIndex: '9999',
    fontFamily: 'Arial, sans-serif',
    fontSize: '16px',
  });
  document.body.appendChild(toast);

  // Добавление стилей для табов/анимации, оставлено
  const style = document.createElement('style');
  style.innerHTML = `
    .tab-pane {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .tab-pane.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .pulse-animate {
      animation: pulse 0.4s ease;
    }
    #toast.show {
      opacity: 1;
    }
  `;
  document.head.appendChild(style);

  const navButtons = document.querySelectorAll('.bottom-nav button');
  const tabs = document.querySelectorAll('.tab-pane');
  const totalText = document.getElementById('total');
  const cartBody = document.getElementById('cart-body');
  const modal = document.getElementById('modal');
  const checkoutBtn = document.getElementById('checkout-btn');
  const modalReviews = document.getElementById('modal-reviews');
  const reviewInput = document.getElementById('reviewInput');
  const submitReview = document.getElementById('submitReview');

  let cart = {}, total = 0, currentProduct = '', telegramUser = Telegram.WebApp.initDataUnsafe?.user || null;

  function goToTab(id) {
    tabs.forEach(t => t.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
    navButtons.forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-tab="${id}"]`)?.classList.add('active');
  }

  function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    clearTimeout(toast._timeout);
    toast._timeout = setTimeout(() => toast.classList.remove('show'), 2500);
  }

  function addToCart(name, price, image) {
    if (!cart[name]) cart[name] = { name, price, image, count: 0 };
    cart[name].count++;
    total += price;
    updateCartDisplay();
    showToast(`🛒 «${name}» добавлен в корзину`);
  }

  function updateCartDisplay() {
    cartBody.innerHTML = '';
    if (!Object.keys(cart).length) {
      cartBody.textContent = 'Здесь будут ваши товары.';
      totalText.textContent = '0,00 ₽';
      checkoutBtn.style.display = 'none';
      return;
    }

    for (const item of Object.values(cart)) {
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${item.image}" alt="">
        <div class="product-info">
          <div class="product-title">${item.name}</div>
          <div class="product-price">${item.price} ₽ × ${item.count}</div>
          <div class="cart-controls">
            <button class="dec" data-name="${item.name}">−</button>
            <button class="inc" data-name="${item.name}">+</button>
          </div>
        </div>`;
      cartBody.appendChild(div);
    }

    totalText.textContent = total.toFixed(2) + ' ₽';
    checkoutBtn.style.display = 'block';

    cartBody.querySelectorAll('.inc').forEach(btn => {
      btn.onclick = () => {
        const name = btn.dataset.name;
        cart[name].count++;
        total += cart[name].price;
        updateCartDisplay();
      };
    });

    cartBody.querySelectorAll('.dec').forEach(btn => {
      btn.onclick = () => {
        const name = btn.dataset.name;
        if (!cart[name]) return;
        cart[name].count--;
        total -= cart[name].price;
        if (cart[name].count <= 0) delete cart[name];
        updateCartDisplay();
      };
    });
  }

  navButtons.forEach(btn => {
    btn.addEventListener('click', () => goToTab(btn.dataset.tab));
  });

  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.product-card');
      const name = card.dataset.name;
      const price = parseFloat(card.dataset.price);
      const image = card.dataset.image;
      addToCart(name, price, image);

      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = '✅ Добавлено!';
      btn.classList.add('pulse-animate');
      btn.style.background = 'linear-gradient(90deg, #8cff00, #ff5a75)';

      setTimeout(() => {
        btn.textContent = original;
        btn.disabled = false;
        btn.classList.remove('pulse-animate');
        btn.style.background = '';
      }, 1500);
    });
  });

  document.querySelectorAll('.details-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.product-card');
      document.getElementById('modal-img').src = card.dataset.image;
      document.getElementById('modal-title').textContent = card.dataset.name;
      document.getElementById('modal-desc').textContent = card.dataset.desc;
      document.getElementById('modal-price').textContent = card.dataset.price + ' ₽';
      modal.classList.remove('hidden');

      currentProduct = card.dataset.name;
      loadReviews();

      document.getElementById('modal-add').onclick = () => {
        addToCart(card.dataset.name, +card.dataset.price, card.dataset.image);
        modal.classList.add('hidden');
      };
    });
  });

  document.getElementById('detailsCloseBtn')?.addEventListener('click', () => modal.classList.add('hidden'));
  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
      e.target.classList.add('hidden');
    }
  });

  document.getElementById('checkout-promo-btn')?.addEventListener('click', () => {
    const input = document.getElementById('checkout-promo-input');
    const promo = input.value.trim().toLowerCase();
    const message = document.getElementById('checkout-promo-message');
    if (promo === 'dutroux') {
      const discount = total * 0.1;
      const newTotal = total - discount;
      message.style.color = 'lime';
      message.textContent = `🎉 Промокод применён! Скидка: ${discount.toFixed(2)} ₽`;
      document.getElementById('order-total').textContent = newTotal.toFixed(2) + ' ₽';
    } else {
      message.style.color = 'red';
      message.textContent = '❌ Промокод не найден';
    }
  });

  function loadReviews() {
    const key = `reviews_${currentProduct}`;
    const reviews = JSON.parse(localStorage.getItem(key) || '[]');
    modalReviews.innerHTML = '';
    if (!reviews.length) {
      modalReviews.innerHTML = '<p>Отзывов пока нет.</p>';
    } else {
      reviews.forEach(r => {
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `<span class="review-author">${r.name}</span>: ${r.text}`;
        modalReviews.appendChild(div);
      });
    }
  }

  submitReview?.addEventListener('click', () => {
    const text = reviewInput.value.trim();
    if (!text) return alert('Напишите отзыв!');
    const name = telegramUser
      ? `${telegramUser.first_name} ${(telegramUser.last_name || '').trim()}`
      : 'Аноним';

    const key = `reviews_${currentProduct}`;
    const reviews = JSON.parse(localStorage.getItem(key) || '[]');
    reviews.push({ name, text });
    localStorage.setItem(key, JSON.stringify(reviews));
    reviewInput.value = '';
    loadReviews();
  });

  checkoutBtn?.addEventListener('click', () => {
    const container = document.getElementById('order-items-container');
    container.innerHTML = '';
    Object.values(cart).forEach(item => {
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <div class="product-info">
          <div class="product-title">${item.name}</div>
          <div class="product-description">Количество: ${item.count}</div>
          <div class="product-price">${item.price} ₽ × ${item.count} = ${(item.price * item.count).toFixed(2)} ₽</div>
        </div>
      `;
      container.appendChild(div);
    });

    document.getElementById('order-total').textContent = total.toFixed(2) + ' ₽';
    document.getElementById('orderModal').classList.remove('hidden');
  });

  // КНОПКА ОПЛАТЫ
  document.getElementById('paidButton')?.addEventListener('click', () => {
    if (!Telegram.WebApp || !Telegram.WebApp.openInvoice) {
      showToast("⚠️ Telegram WebApp API не поддерживается");
      return;
    }

    const payload = {
      title: "Оплата заказа",
      description: "Покупка товаров в Dutroux Sell",
      payload: "order_" + Date.now(),
      provider_token: "1754495953908DEMO",
      currency: "RUB",
      prices: [
        { label: "Товары", amount: Math.round(total * 100) }
      ],
      need_name: true,
      photo_url: "logo.png",
      photo_width: 512,
      photo_height: 512,
      is_flexible: false
    };

    Telegram.WebApp.openInvoice(payload, function (status) {
      if (status === 'paid') {
        showToast("✅ Оплата успешна!");
        cart = {};
        total = 0;
        updateCartDisplay();
        document.getElementById('orderModal').classList.add('hidden');
      } else {
        showToast("❌ Оплата не завершена");
      }
    });
  });

  const savedAvatar = localStorage.getItem('customAvatar');
  if (savedAvatar) {
    document.getElementById('user-avatar').src = savedAvatar;
  }

  updateCartDisplay();
});
</script>

</body>
</html>
